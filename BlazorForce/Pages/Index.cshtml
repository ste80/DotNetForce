@using DotNetForce;
@using LZStringCSharp;
@inject Microsoft.AspNetCore.Blazor.Services.IUriHelper UriHelper;
@page "/"

<div class="container-fluid">
    @if (Hash == null)
    {
        <div class="jumbotron mt-3">
            <h1 class="display-4">DotNetForce</h1>
            <p class="lead">Loading...</p>
            <hr class="my-4">
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
            </div>
        </div>
    }
    else
    {
        if (Hash.StartsWith("/oauth2/"))
        {
            var oauth2 = UriHelper.GetHashAsDictionary("/oauth2/");
            <OAuth2 Code="@oauth2["code"]" LoginDomain="@oauth2["state"]" Storage="@Storage"></OAuth2>
        }
        else if (Hash.StartsWith("/org/"))
        {
            var org = Uri.UnescapeDataString(Hash.Substring("/org/".Length));
            <Org InstanceUrl="@org" Storage="@Storage"></Org>
        }
        else if (Hash.StartsWith("/DataExport/"))
        {
            <DataExport></DataExport>
        }
        else if (Hash.StartsWith("/DataImport/"))
        {
            <DataImport></DataImport>
        }
        else {
            <Login Storage="@Storage"></Login>
        }
    }
</div>
@*<SurveyPrompt Title="How is Blazor working for you?" />*@

@functions
{
    private AppStorageSetting Storage { get; set; }
    private string Url { get; set; }
    private string Hash { get; set; }

    protected override async Task OnInitAsync()
    {
        Storage = await AppStorageSetting.GetAsync();
        Url = UriHelper.GetAbsoluteUri();
        Hash = UriHelper.GetHash() ?? "";
        UriHelper.OnLocationChanged += OnLocationChanged;
    }

    //private void Reload()
    //{
    //    Console.WriteLine($"Reload {Url} {Hash}");
    //    Url = UriHelper.GetAbsoluteUri();
    //    Hash = UriHelper.GetHash() ?? "";
    //    Console.WriteLine($"Reload {Url} {Hash} complelte.");
    //    StateHasChanged();
    //}

    private void OnLocationChanged(object sender, string newUriAbsolute)
    {
        Url = newUriAbsolute;
        Hash = UriHelper.GetHash() ?? "";
        StateHasChanged();
        //Console.WriteLine($"Url: {Url}");
    }

    //private async Task CancelAsync()
    //{
    //    await JsInterop.Current.History.ReplaceState(null, null, "");
    //    Reload();
    //}

    public void Dispose()
    {
        UriHelper.OnLocationChanged -= OnLocationChanged;
    }
}